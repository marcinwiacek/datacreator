<html>

<head>
    <meta charset="utf-8">
    <style>
        .row {
            display: flex;
        }

        .col {
            flex: 50%;
        }
    </style>
</head>

<body>
    <input type="file" id="file" name="file" />
    <p>
    <div class=row>
        <div class=col id=f></div>
        <pre class=col id=o></pre>
    </div>
    <script>
        var jsonTxt = "";
        var output = {};
        var debug = false;

        function deleteArray(id) {
            console.log(id);
            var out = output;
            var json = JSON.parse(jsonTxt);
            var idObj0 = [];
            var idObj = id.split(",");
            while (true) {
                console.log("idobj " + idObj);
                console.log("idobj0 " + idObj[0]);
                console.log("json " + JSON.stringify(json));
                if (idObj[0].includes("[")) {
                    var info = idObj[0].split(/[\[,\]]/);
                    idObj0.push(info[0]);
                    var xParent = document.getElementById(idObj0.toString());
                    console.log("parent " + idObj0.toString());
                    idObj0.pop();
                    idObj0.push(idObj[0]);
                    var xChild = document.getElementById(idObj0.toString());
                    console.log("child " + idObj0.toString());
                    var newIndex = -1;
                    for (i in xParent.children) {
                        if (xParent.children[i] === xChild) newIndex = i;
                    }
                    console.log(newIndex + " " + info[0] + " " + JSON.stringify(out));
                    if (idObj.length == 1) {
                        out[info[0]].splice(newIndex, 1);
                        console.log("removing index " + info[1]);
                    } else {
                        out = out[info[0]][newIndex];
                    }
                    json = json[info[0]];
                    idObj.shift();
                } else {
                    idObj0.push(idObj[0]);
                    var xParent = document.getElementById(idObj0.toString());
                    for (j = 1; j < json[idObj[0]].length; j += 2) {
                        if (json[idObj[0]][j] == xParent.value) {
                            json = json[idObj[0]][j + 1];
                            break;
                        }
                    }
                    idObj.shift();
                }
                if (idObj.length == 0) break;
            }
            console.log("json " + JSON.stringify(json));
            var allEl = document.getElementsByName(json[2]);
            for (j = 0; j < allEl.length; j++) {
                toDelete = -1;
                for (jj = 0; jj < allEl[j].length; jj++) {
                    if (allEl[j][jj].value == newIndex) toDelete = jj;
                }
                allEl[j].remove(toDelete);
            }
            document.getElementById(id).remove();
            document.getElementById("o").innerHTML = JSON.stringify(output, null, 2);
        }

        function addArray(id) {
            console.log(id);
            output = addArray2(id, output, JSON.parse(jsonTxt));
        }

        function addArray2(id, out, json) {
            var idObj = id.split(",");
            var idObjJson = id.split(",");
            var arr = [];
            var relatedIndexes = [];
            if (json[idObj[0]][0] == "p") {
                for (j = 1; j < json[idObj[0]].length; j += 2) {
                    if (json[idObj[0]][j] == document.getElementById(idObj[0]).value) {
                        arr = json[idObj[0]][j + 1];
                    }
                }
                relatedIndexes = arr[idObj[1]][2];
                arr = arr[idObj[1]][1];
                idObjJson.shift();
            } else if (json[idObj[0]][0] == "a") {
                arr = json[idObj[0]][1];
                relatedIndexes = json[idObj[0]] ? json[idObj[0]][2] : null;
            }
            var id2 = idObj.slice().toString();
            console.log(id2);
            var i = 0;
            var newId = id2 + "[" + i + "]";
            while (document.getElementById([newId]) != null) {
                i = i + 1;
                newId = id2 + "[" + i + "]";
            }
            console.log("search for " + relatedIndexes);
            if (relatedIndexes) {
                var allEl = document.getElementsByName(relatedIndexes);
                for (j = 0; j < allEl.length; j++) {
                    console.log(allEl[j]);
                    var op = document.createElement('option');
                    op.value = i;
                    op.innerHTML = i;
                    console.log(allEl[j]);
                    allEl[j].add(op);
                }
            }
            var o = {};
            const d = parseJson(arr, o, [newId], i);
            out[idObjJson[0]].push(o);
            newDivElement = document.createElement('div');
            newDivElement.id = newId;
            newDivElement.innerHTML =
                "<br><input type=button value='delete' onclick=deleteArray('" + newId + "');>" +
                (debug ? "id " + JSON.stringify(id2) : "") + "<br>" +
                d[0];
            document.getElementById(id2).appendChild(newDivElement);
            document.getElementById("o").innerHTML = JSON.stringify(out, null, 2);
            return out;
        }

        function updateParam(id, value) {
            console.log(id);
            updateParam2(id, value, JSON.parse(jsonTxt));
        }

        function updateParam2(id, value, json) {
            var idObj = id.split(",");
            if (idObj.length == 1) {
                var x = json[idObj[0]];
                console.log(x);
            }
        }

        function updateInput(id, value, num) {
            console.log(id);
            var out = output;
            var json = JSON.parse(jsonTxt);
            var idObj0 = [];
            var idObj = id.split(",");
            while (true) {
                console.log("idobj " + idObj);
                console.log("idobj0 " + idObj[0]);
                if (idObj[0].includes("[")) {
                    var info = idObj[0].split(/[\[,\]]/);
                    idObj0.push(info[0]);
                    var xParent = document.getElementById(idObj0.toString());
                    console.log("parent " + idObj0.toString());
                    idObj0.pop();
                    idObj0.push(idObj[0]);
                    var xChild = document.getElementById(idObj0.toString());
                    console.log("child " + idObj0.toString());
                    var newIndex = -1;
                    for (i in xParent.children) {
                        if (xParent.children[i] === xChild) newIndex = i;
                    }
                    out = out[info[0]][newIndex];
                    json = json[info[0]];
                    idObj.shift();
                } else if (idObj.length == 1) {
                    if (num) {
                        out[idObj[0]] = Number(value);
                    } else {
                        out[idObj[0]] = value;
                    }
                    break;
                } else {
                    idObj0.push(idObj[0]);
                    var xParent = document.getElementById(idObj0.toString());
                    for (j = 1; j < json[idObj[0]].length; j += 2) {
                        if (json[idObj[0]][j] == xParent.value) {
                            json = json[idObj[0]][j + 1];
                            break;
                        }
                    }
                    idObj.shift();
                }
            }
            document.getElementById("o").innerHTML = JSON.stringify(output, null, 2);
        }

        function parseJson(json, out, id, newId) {
            var retVal = "";
            for (var i in json) {
                if (json[i][0] == "a") {
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <input type=button value='add' onclick=addArray('" + id2.toString() + "');>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<div id='" + id2.toString() + "' style='margin-left: 30px;'>";
                    retVal += "<div id='" + id2.toString() + "[0]'>";
                    retVal += "<br><input type=button value='delete' onclick=deleteArray('" + id2.toString() + "[0]');>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    var arr = [];
                    out[i] = arr;
                    var arrEl = {};
                    var id2 = id.slice();
                    id2.push(i + "[0]");
                    r = parseJson(json[i][1], arrEl, id2);
                    retVal += r[0];
                    arr.push(r[1]);
                    retVal += "</div>";
                    retVal += "</div>";
                } else if (json[i][0] == "c") { //combo box
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <select onchange=updateInput('" + id2.toString() + "',this.value,false);>";
                    for (j = 1; j < json[i].length; j++) retVal += "<option value='" + json[i][j] + "'>" + json[i][j] + "</option>";
                    retVal += i + " </select>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    var el = json[i][1];
                    out[i] = el;
                } else if (json[i][0] == "r") { //read index
                    var id2 = id.slice();
                    id2.push(i);
                    var id3 = id.slice();
                    id3[0] = "book";
                    id3.push(i);
                    retVal += i + " <select name='" + id3.toString() + "' onchange=updateInput('" + id2.toString() + "',this.value,false);>";

                    var allEl = document.getElementById(json[i][1]);
                    if (allEl != null) {
                        console.log(allEl.children.length);
                        for (j = 0; j < allEl.children.length; j++) {
                            console.log(allEl.children[j]);
                            retVal += "<option value='" + j + "'>" + j + "</option>";
                        }
                    } else {
                        retVal += "<option value='0'>0</option>";
                    }
                    retVal += i + " </select>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    out[i] = 0;
                } else if (json[i][0] == "u") { //index
                    out[i] = newId;
                } else if (json[i][0] == "s") { //string
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <input oninput=updateInput('" + id2.toString() + "',this.value,false);>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    out[i] = "";
                } else if (json[i][0] == "i") { //integer
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <input value='0' type=number oninput=updateInput('" + id2.toString() + "',this.value,true);>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    out[i] = 0;
                } else if (json[i][0] == "b") { //bool
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <input value=true type=checkbox  oninput=updateInput('" + id2.toString() + "',this.value,true);>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    out[i] = false;
                } else if (json[i][0] == "f") { //file
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <input  type=file  oninput=updateFile('" + id2.toString() + "',this.value);>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    out[i] = "";
                } else if (json[i][0] == "d") { //date
                    var id2 = id.slice();
                    id2.push(i);
                    const date = new Date();
                    const val = date.getFullYear() + "-" +
                        (date.getMonth() + 1 < 10 ? "0" : "") +
                        (date.getMonth() + 1) + "-" +
                        (date.getDate() < 10 ? "0" : "") +
                        date.getDate();
                    retVal += i + " <input value='" + val +
                        "' oninput=updateInput('" + id2.toString() + "',this.value); type=date>";
                    if (debug) retVal += "id " + JSON.stringify(id2);
                    retVal += "<br>";
                    out[i] = val;
                } else if (json[i][0] == "p") { //parameter
                    var id2 = id.slice();
                    id2.push(i);
                    retVal += i + " <select id='" + id2.toString() + "' onchange=updateParam('" + id2.toString() + "',this.value);>";
                    for (j = 1; j < json[i].length; j += 2) retVal += "<option value='" + json[i][j] + "'>" + json[i][j] + "</option>";
                    retVal += i + " </select>";
                    retVal += "<div id='" + id2.toString() + "' style='margin-left: 30px;'>";
                    if (debug) retVal += "id " + JSON.stringify(id);
                    var arrEl = {};
                    r = parseJson(json[i][2], arrEl, id2);
                    retVal += r[0];
                    for (var j in r[1]) {
                        out[j] = r[1][j];
                    }
                    retVal += "</div>";
                }
            }
            return [retVal, out];
        }

        function createPage() {
            const d = parseJson(JSON.parse(jsonTxt), output, [], 0);
            document.getElementById("f").innerHTML = d[0];
            output = d[1];
            document.getElementById("o").innerHTML = JSON.stringify(output, null, 2);
        }

        document.getElementById("file").addEventListener("change",
            function(e) {
                const fReader = new FileReader();
                fReader.onload = function(e2) {
                    jsonTxt = e2.target.result;
                    try {
                        JSON.parse(jsonTxt);
                        createPage();
                    } catch (ee) {
                        alert(ee.message)
                    }
                };
                fReader.readAsText(e.target.files[0]);
            });
    </script>
</body>

</html>