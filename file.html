<html>
<head>
    <meta charset="utf-8">
</head>
<body>
<input type="file" id="file" name="file" />
<div id=f></div>
<pre id=o></pre>
<script>
var jsonTxt = "";
var output = {};

function addArray(id) {
    addArray2(id,output,JSON.parse(jsonTxt));
}

function addArray2(id,out,json) {
    var idObj = id.split(",");
    if (idObj.length==1) {
	var id2=id.slice();
	var i = 1;
	var newId = id2+"["+i+"]";
	while (document.getElementById([newId]) != null) {
	    i=i+1;
	    newId = id2+"["+i+"]";
	}
	var o = {};
	const d = parseJson(json[idObj[0]][1],o,[newId]);
	out[idObj[0]].push(o);
	document.getElementById(id2).innerHTML=
	    document.getElementById(id2).innerHTML+
	    "<div id='"+newId+"'>"+d[0]+"<div>";
	const x = JSON.stringify(out, null, 2);
	document.getElementById("o").innerHTML = x;
    }
}

function updateInput(id,value) {
    updateInput2(id,value,output);
    const x = JSON.stringify(output, null, 2);
    document.getElementById("o").innerHTML = x;
}

function updateInput2(id,value,out) {
    var idObj = id.split(",");
    if (idObj.length==1) {
        out [idObj[0]]=value;
    } else {
	var idObj2 = id.split(",");
	idObj2.shift();
	var info = idObj[0].split(/[\[,\]]/);
    	updateInput2(idObj2.toString(),value,out[info[0]][info[1]]);
    }
}

function parseJson(json,out,id) {
    var retVal="";
    for (var i in json) {
	if (json[i][0]=="a") {
	    var id2=id.slice();
	    id2.push(i);
	    retVal+="<br>"+i+" <input type=button value='add' onclick=addArray('"+id2.toString()+"');>id "+JSON.stringify(id2);
	    retVal+="<div id='"+id2.toString()+"'>";
	    var arr = [];
	    out[i] = arr;
	    var arrEl = {};
	    var id2=id.slice();
	    id2.push(i+"[0]");
	    r=parseJson(json[i][1],arrEl,id2);
	    retVal+=r[0];
	    arr.push(r[1]);
	    retVal+="</div>";
        } else if (json[i][0]=="s") {
	    var id2=id.slice();
	    id2.push(i);
	    retVal+=i+" <input oninput=updateInput('"+id2.toString()+"',this.value);>id "+JSON.stringify(id2)+"<br>";
	    var el = "";
	    out[i] = el;
	}
    }
    return [retVal+"<br>",out];
}

function createPage() {
    const d = parseJson(JSON.parse(jsonTxt),output,[]);
    output = d[1];
    document.getElementById("f").innerHTML=d[0];
    const x = JSON.stringify(output, null, 2);
    document.getElementById("o").innerHTML = x;
}

document.getElementById("file").addEventListener("change",
    function(evt) {
	const fReader = new FileReader();
        fReader.onload = function(e) {
	    jsonTxt = e.target.result;
	    createPage();
        };
        fReader.readAsText(evt.target.files[0]);
    });
</script>
</body>
</html>
