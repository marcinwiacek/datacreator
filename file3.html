<html>

<head>
    <meta charset="utf-8">
    <style>
        label {
            grid-column: 1 / 2;
        }

        input,
        button,
        span {
            grid-column: 2 / 3;
        }

        .full {
            grid-column: 1 / 3;
        }
    </style>
</head>

<body>
    <input type="file" id="file" name="file" />
    <span id="errors"></span>
    <p>
    <div style="display: flex;">
        <div style="flex: 40%; display: grid; grid-template-columns: 1fr 1fr" id="editor"></div>
        <pre style="flex: 60%; margin: 30px;" id="json"></pre>
    </div>
    <script>
        var inputData = "";
        var outputData = {};
        var debug = false;

        function findOutputObject(path) {
            console.log("findOutputPath " + path);
            var obj = outputData;
            var pathObj = path.split(".");
            var newValue = false;
            for (var i = 0; i < pathObj.length; i++) {
                console.log("element " + pathObj[i]);
                //array?
                if (pathObj[i].includes("[")) {
                    var info = pathObj[i].split(/[\[,\]]/);
                    if (obj[info[0]] == null) {
                        obj[info[0]] = [];
                        console.log("creating array");
                        newValue = true;
                    }
                    //we don't have index = we create new one
                    if (info[1] == "") {
                        obj = obj[info[0]];
                        obj.push({});
                        newValue = true;
                        pathObj[i] = info[0] + "[" + (obj.length - 1) + "]";
                        if (i == pathObj.length - 1) break;
                        obj = obj[obj.length - 1];
                    } else {
                        if (i == pathObj.length - 1) break;
                        if (obj[info[0]][info[1]] == null) {
                            console.log("no error ");
                            console.log(obj);
                            obj = obj[info[0]];
                            obj.push({});
                            newValue = true;
                            if (Number(info[1]) == obj.length - 1) {
                                obj = obj[info[1]];
                            }
                        } else {
                            obj = obj[info[0]][info[1]];
                        }
                    }
                } else {
                    if (obj[pathObj[i]] == null) {
                        newValue = true;
                        obj[pathObj[i]] = i != pathObj.length - 1 ? {} : "";
                    }
                    if (i == pathObj.length - 1) break;
                    obj = obj[pathObj[i]];
                }
            }
            var retVal = {};
            retVal.obj = obj;
            retVal.lastPathElement = pathObj[pathObj.length - 1];
            retVal.path = pathObj.join(".");
            retVal.isNewValue = newValue;
            console.log(retVal);
            return retVal;
        }

        function parseEditErrors(section, element, value) {
            var retVal = "";
            var obj = inputData[section][element];
            if (obj[0] == "string") {
                if (obj[2] != "" && !value.match(new RegExp("^" + obj[2] + "$"))) {
                    retVal += "<font color=red>Text doesn't match regular exp. " + obj[2] + "</font>";
                }
                if (obj[4] != obj[5]) {
                    if (value.length < Number(obj[4])) {
                        retVal += "<font color=red>Minimal length " + obj[4] + "</font>";
                    }
                    if (value.length > Number(obj[5])) {
                        retVal += "<font color=red>Maximal length " + obj[5] + "</font>";
                    }
                }
            } else if (obj[0] == "number" && obj[3] != obj[4]) {
                if (Number(value) < Number(obj[3])) {
                    retVal += "<font color=red>Minimal value " + obj[3] + "</font>";
                }
                if (Number(value) > Number(obj[4])) {
                    retVal += "<font color=red>Maximal value " + obj[4] + "</font>";
                }
            }
            return retVal;
        }

        function setEditErrors(path, value, section, element) {
            document.getElementById(path + "_error").innerHTML = parseEditErrors(section, element, value);
        }

        function editStringBoolNum(path, value, num) {
            pathList = path.split(",");
            for (p in pathList) {
                var obj = findOutputObject(pathList[p]);
                obj.obj[obj.lastPathElement] = num ? Number(value) : value;
            }
            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
        }

        function processSelect(path, value) {
            console.log("processSelect '" + path + "' '" + value + "'");
            var pathObj = path.split(".");
            var elementToProcess = inputData[pathObj[0]][pathObj[1]];
            console.log(elementToProcess);
            for (var j = 2; j < elementToProcess.length; j = j + 3) {
                if (elementToProcess[j] == value) {
                    //process section "before"
                    if (elementToProcess[j + 1] != "") processEditorPart(elementToProcess[j + 1], "");
                    //process "target" section
                    document.getElementById(path).innerHTML = processEditorPart(elementToProcess[j + 2], "");
                    document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                    break;
                }
            }
        }

        function deleteArrayElement(path) {
            var obj = findOutputObject(path);
            var info = obj.lastPathElement.split(/[\[,\]]/);
            //remove from json
            obj.obj[info[0]].splice(info[1], 1);
            //remove from editor
            document.getElementById(path).remove();
            //change id for allowing searching all elements
            var pathObj = path.split(".");
            pathObj[pathObj.length - 1] = info[0];
            obj0 = [document.getElementsByTagName("input"),
                document.getElementsByTagName("select"),
                document.getElementsByTagName("div"),
                document.getElementsByTagName("button")
            ];
            for (jj in obj0) {
                obj = obj0[jj];
                for (j in obj) {
                    //remove value from select with array index
                    if (obj[j].attributes && obj[j].attributes["name"]) {
                        if (obj[j].attributes["name"]["nodeValue"] == pathObj.join(".") + "[]") {
                            //remove highest value
                            toDelete = -1;
                            toDeleteValue = 0;
                            for (jjj = 0; jjj < obj[j].length; jjj++) {
                                if (Number(obj[j][jjj].value) >= toDeleteValue) {
                                    toDelete = jjj;
                                    toDeleteValue = Number(obj[j][jjj].value);
                                }
                            }
                            obj[j].remove(toDelete);
                            //todo: select new value in select
                            if (obj[j].length == 0) {
                                editStringBoolNum(obj[j].id, "", false);
                            }
                        }
                    }
                    //update indexes of existing elements in the array
                    if (obj[j].id != null && obj[j].id.startsWith(pathObj.join("."))) {
                        pathObj2 = obj[j].id.split(".");
                        var info2 = pathObj2[pathObj.length - 1].split(/[\[,\]]/);
                        if (Number(info2[1]) > Number(info[1])) {
                            var i = Number(info2[1]);
                            pathObj2[pathObj.length - 1] = info2[0] + "[" + (i - 1) + "]";
                            obj[j].id = pathObj2.join(".");
                            //update json value for array indexes
                            if (obj[j].attributes && obj[j].attributes["name"] &&
                                obj[j].attributes["name"]["nodeValue"] == "arrayindex") {
                                var obj2 = findOutputObject(pathObj2.join("."));
                                obj2.obj[obj2.lastPathElement] = Number(i - 1);
                            }
                        }
                    }
                }
            }
            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
        }

        function addArrayElement(path, path2, parentPath) {
            var obj = findOutputObject(parentPath);
            newButtonElement = document.createElement('button');
            newButtonElement.id = obj.path + ".x";
            newButtonElement.addEventListener('click', function(event) {
                deleteArrayElement(this.id.slice(0, -2));
            });
            newButtonElement.innerText = "Delete";
            newDivElement = document.createElement('div');
            newDivElement.classList.add("full");
            newDivElement.style = "display: grid; grid-template-columns: 1fr 1fr;";
            newDivElement.innerHTML = processEditorPart(path2, obj.path + ".");
            newDivElement.id = obj.path;
            newDivElement.appendChild(newButtonElement);
            document.getElementById(path).appendChild(newDivElement);
            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
            //add new value into all related indexes
            var info = obj.lastPathElement.split(/[\[,\]]/);
            var pathObj = path.split(".");
            var elementsToProcess = inputData[pathObj[0]][pathObj[1]];
            obj = document.getElementsByTagName("select");
            for (j in obj) {
                if (obj[j].attributes && obj[j].attributes["name"] &&
                    obj[j].attributes["name"]["nodeValue"] == elementsToProcess[3]) {
                    var op = document.createElement('option');
                    op.value = info[1];
                    op.innerHTML = info[1];
                    obj[j].add(op);
                    if (obj[j].length == 1) {
                        editStringBoolNum(obj[j].id, info[1], false);
                    }
                }
            }
        }

        function loadBase64File(f, path) {
            const reader = new FileReader();
            reader.onload = function(e2) {
                binaryFile = e2.target.result;
                var obj = findOutputObject(path);
                obj.obj[obj.lastPathElement] = btoa(binaryFile);
                document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
            };
            reader.readAsBinaryString(f);
        }

        function loadHexFile(f, path) {
            const reader = new FileReader();
            reader.onload = function(e2) {
                binaryFile = e2.target.result;
                var obj = findOutputObject(path);
                obj.obj[obj.lastPathElement] = btoa(binaryFile);
                document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
            };
            reader.readAsBinaryString(f);
        }

        function getPathValueToCheck(parentPath, path, value) {
            valueToCheck = value;
            pathList = path.split(",");
            for (p in pathList) {
                obj = findOutputObject(parentPath + pathList[p]);
                if (obj.isNewValue) {
                    obj.obj[obj.lastPathElement] = value;
                } else {
                    valueToCheck = obj.obj[obj.lastPathElement];
                }
                pathList[p] = obj.path;
            }
            var retVal = {};
            retVal.path = pathList.join(",");
            retVal.value = valueToCheck;
            return retVal;
        }

        function processEditorPart(section, parentPath) {
            console.log("processEditorPart start '" + section + "' '" + parentPath + "'");
            var editorText = "";
            var elementsToProcess = inputData[section];
            for (i in elementsToProcess) {
                console.log(elementsToProcess[i]);
                if (elementsToProcess[i][0] == "select") { //option menu. Can do something extra during changing to concrete value.	
                    editorText += "<label>" + elementsToProcess[i][1] + "</label>";
                    editorText += "<select onchange=processSelect('" + section + "." + i + "',this.value);>";
                    for (j = 2; j < elementsToProcess[i].length; j = j + 3) {
                        editorText += "<option value='" + elementsToProcess[i][j] + "'>" + elementsToProcess[i][j] + "</option>";
                    }
                    editorText += "</select>";
                    editorText += "<div id='" + section + "." + i + "' class=full style='margin-left: 10px; display: grid; grid-template-columns: 1fr 1fr;'>";
                    editorText += processEditorPart(elementsToProcess[i][4], parentPath) + "</div>";
                } else if (elementsToProcess[i][0] == "array") { //array with adding/removing elements
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><input type=button";
                    editorText += " onclick=addArrayElement('" + section + "." + i + "','" + elementsToProcess[i][2] + "','" + parentPath + elementsToProcess[i][3] + "');";
                    editorText += " value='Add'>";
                    editorText += "<div id='" + section + "." + i + "' class=full style='margin-left: 10px; display: grid; grid-template-columns: 1fr 1fr;'></div>";
                } else if (elementsToProcess[i][0] == "index") { //field with index of some array
                    obj2 = parentPath.slice(0, -1).split(".");
                    info = obj2[obj2.length - 1].split(/[\[,\]]/);
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], Number(info[1]));
                    editorText += "<div name=arrayindex id='" + pathValue.path + "'></div>";
                } else if (elementsToProcess[i][0] == "other") { //field with other array index (for selecting)
                    obj = findOutputObject(parentPath + elementsToProcess[i][elementsToProcess[i].length - 1]);
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><select name='" + elementsToProcess[i][2] + "' id='" + elementsToProcess[i][3] + "' ";
                    editorText += "oninput=editStringBoolNum(this.id,this.value,false);>";
                    editorText += "</select>";
                } else if (elementsToProcess[i][0] == "delete") { //deleting smth from json
                    pathList = elementsToProcess[i][1].split(",");
                    for (p in pathList) {
                        obj = findOutputObject(parentPath + pathList[p]);
                        if (obj != null) delete obj.obj[obj.lastPathElement];
                    }
                } else if (elementsToProcess[i][0] == "const") {
                    pathList = elementsToProcess[i][2].split(",");
                    for (p in pathList) {
                        obj = findOutputObject(parentPath + pathList[p]);
                        if (obj.isNewValue) {
                            obj.obj[obj.lastPathElement] = elementsToProcess[i][1];
                        }
                    }
                } else if (elementsToProcess[i][0] == "string") {
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][6], elementsToProcess[i][3]);
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><input";
                    editorText += " value='" + pathValue.value + "'";
                    if (elementsToProcess[i][4] != elementsToProcess[i][5]) {
                        editorText += " minlength=" + elementsToProcess[i][4];
                        editorText += " maxlength=" + elementsToProcess[i][5];
                    }
                    editorText += " id='" + pathValue.path + "' oninput=editStringBoolNum(this.id,this.value,false);setEditErrors(this.id,this.value,'" + section + "','" + i + "');><br>";
                    editorText += "<span id='" + pathValue.path + "_error'>";
                    editorText += parseEditErrors(section, i, pathValue.value);
                    editorText += "</span>";
                } else if (elementsToProcess[i][0] == "number") {
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][6], elementsToProcess[i][2]);
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><input ";
                    if (elementsToProcess[i][3] != elementsToProcess[i][4]) {
                        editorText += " min=" + elementsToProcess[i][3];
                        editorText += " max=" + elementsToProcess[i][4];
                    }
                    editorText += " value=" + pathValue.value + " step=" + elementsToProcess[i][5] + " type=number ";
                    editorText += "id='" + pathValue.path + "' oninput=editStringBoolNum(this.id,this.value,true);setEditErrors(this.id,this.value,'" + section + "','" + i + "');><br>";
                    editorText += "<span id='" + pathValue.path + "_error'>";
                    editorText += parseEditErrors(section, i, pathValue.value);
                    editorText += "</span>";
                } else if (elementsToProcess[i][0] == "date") {
                    const date = new Date();
                    const dateVal = date.getFullYear() + "-" +
                        (date.getMonth() + 1 < 10 ? "0" : "") + (date.getMonth() + 1) + "-" +
                        (date.getDate() < 10 ? "0" : "") + date.getDate();
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][6], elementsToProcess[i][2] == "" ? dateVal : elementsToProcess[i][2]);
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><input value='" + pathValue.value + "' ";
                    if (elementsToProcess[i][3] != elementsToProcess[i][4]) {
                        editorText += " min=" + elementsToProcess[i][3];
                        editorText += " max=" + elementsToProcess[i][4];
                    }
                    editorText += " id='" + pathValue.path + "' type=date oninput=editStringBoolNum(this.id,this.value,false);><br>";
                } else if (elementsToProcess[i][0] == "checkbox") { //real true & false in json. For string use option
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][2], false);
                    editorText += "<label>" + elementsToProcess[i][1] + "</label>";
                    editorText += "<input value=true type=checkbox id='" + pathValue.value + "' oninput=editStringBoolNum(this.id,this.checked,false);><br>";
                } else if (elementsToProcess[i][0] == "option") { //select one of predefined options   
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][elementsToProcess[i].length - 1], elementsToProcess[i][2]);
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><select id='" + pathValue.path + "' ";
                    editorText += "onchange=editStringBoolNum(this.id,this.value,false);>";
                    for (j = 2; j < elementsToProcess[i].length - 1; j++) {
                        editorText += "<option value='" + elementsToProcess[i][j] + "'>" + elementsToProcess[i][j] + "</option>";
                    }
                    editorText += "</select>";
                } else if (elementsToProcess[i][0] == "file64") { //Base64 encoded file
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][2], "");
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><input type=file id='" + pathValue.path + "' ";
                    editorText += "onchange=loadBase64File(this.files[0],this.id);><br>";
                } else if (elementsToProcess[i][0] == "fileHex") { //HexDec encoded file
                    pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][2], "");
                    editorText += "<label>" + elementsToProcess[i][1] + "</label><input type=file id='" + pathValue.path + "' ";
                    editorText += "onchange=loadHexFile(this.files[0],this.id);><br>";
                }
            }
            console.log("processEditorPart end '" + section + "' '" + parentPath + "'");
            return editorText;
        }

        document.getElementById("file").addEventListener("change",
            function(e) {
                const fReader = new FileReader();
                fReader.onload = function(e2) {
                    jsonTxt = e2.target.result;
                    try {
                        inputData = JSON.parse(jsonTxt);
                        if (inputData.start == null) {
                            alert("No start section. Is this really file with data?");
                        } else {
                            document.getElementById("editor").innerHTML = processEditorPart("start", "");
                            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                        }
                    } catch (ee) {
                        alert(ee.message)
                    }
                };
                fReader.readAsText(e.target.files[0]);
            });
    </script>
</body>

</html>