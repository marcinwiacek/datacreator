<html>

<head>
    <meta charset="utf-8">
    <style>
        label {
            grid-column: 1 / 2;
        }

        input,
        button,
        select,
        span {
            grid-column: 2 / 3;
        }

        .full {
            grid-column: 1 / 3;
            display: grid;
            grid-template-columns: 1fr 1fr;
        }
    </style>
</head>

<body>
    <input type="file" id="file" name="file" />
    <a id="getOutput" download="output.json" onclick=getOutputJson(); href=''>Get JSON</a>
    <span id="errors"></span>
    <p>
    <div style="display: flex;">
        <span style="flex: 40%; display: grid; grid-template-columns: 1fr 1fr; max-width: 800px;">
            <span id="editor" class="full" style="display:block;"></span>
        </span>
        <pre style="flex: 60%; margin: 30px; max-width: 400px; overflow-x: auto;" id="json"></pre>
    </div>
    <script>
        var inputData, outputData, addArray, selectAddReplace, processing;

        function getOutputJson() {
            document.getElementById("getOutput").setAttribute('href', 'data:;base64,' +
                btoa(JSON.stringify(outputData, null, 2)));
        }

        function findOutputObject(path, canCreate) {
            console.log("findOutputPath " + path);
            var obj = outputData;
            var pathObj = path.split(".");
            var newValue = false;
            var retVal = {};
            retVal.path = pathObj.join(".");
            for (var i = 0; i < pathObj.length; i++) {
                console.log("element " + pathObj[i]);
                //array?
                if (pathObj[i].includes("[")) {
                    var info = pathObj[i].split(/[\[,\]]/);
                    if (obj[info[0]] == null) {
                        if (!canCreate) return retVal;
                        obj[info[0]] = [];
                        console.log("creating array");
                        newValue = true;
                    }
                    //we don't have index = we create new one
                    if (info[1] == "") {
                        obj = obj[info[0]];
                        retVal.obj = obj;
                        if (!canCreate) return retVal;
                        obj.push({});
                        newValue = true;
                        pathObj[i] = info[0] + "[" + (obj.length - 1) + "]";
                        if (i == pathObj.length - 1) break;
                        obj = obj[obj.length - 1];
                    } else {
                        if (i == pathObj.length - 1) break;
                        if (obj[info[0]][info[1]] == null) {
                            if (!canCreate) return retVal;
                            obj = obj[info[0]];
                            obj.push({});
                            newValue = true;
                            if (Number(info[1]) == obj.length - 1) {
                                obj = obj[info[1]];
                            }
                        } else {
                            obj = obj[info[0]][info[1]];
                        }
                    }
                } else {
                    if (obj[pathObj[i]] == null) {
                        if (!canCreate) return retVal;
                        newValue = true;
                        obj[pathObj[i]] = i != pathObj.length - 1 ? {} : "";
                    }
                    if (i == pathObj.length - 1) break;
                    obj = obj[pathObj[i]];
                }
            }
            retVal.obj = obj;
            retVal.lastPathElement = pathObj[pathObj.length - 1];
            retVal.path = pathObj.join(".");
            retVal.isNewValue = newValue;
            console.log(retVal);
            return retVal;
        }

        function parseEditErrors(section, element, value) {
            var retVal = "";
            var obj = inputData[section][element];
            if (obj[0] == "string") {
                if (obj[6] != "" && value != null && !value.match(new RegExp("^" + obj[6] + "$"))) {
                    retVal += "<font color=red>Text doesn't match regular exp. " + obj[6] + "</font>";
                }
                if (obj[4] != 0 || obj[5] != 0) {
                    if (value.length < Number(obj[4])) {
                        retVal += "<font color=red>Minimal length " + obj[4] + "</font>";
                    }
                    if (value.length > Number(obj[5])) {
                        retVal += "<font color=red>Maximal length " + obj[5] + "</font>";
                    }
                }
            } else if (obj[0] == "number" && (obj[4] != 0 || obj[5] != 0)) {
                if (Number(value) < Number(obj[4])) {
                    retVal += "<font color=red>Minimal value " + obj[4] + "</font>";
                }
                if (Number(value) > Number(obj[5])) {
                    retVal += "<font color=red>Maximal value " + obj[5] + "</font>";
                }
            }
            return retVal;
        }

        function setEditErrors(path, value, section, element) {
            document.getElementById(path + "_error").innerHTML = parseEditErrors(section, element, value);
        }

        function editStringBoolNum(path, value, num) {
            pathList = path.split(",");
            for (p in pathList) {
                var obj = findOutputObject(pathList[p], true);
                obj.obj[obj.lastPathElement] = num ? Number(value) : value;
            }
            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
        }

	//what when we have two array? todo
        function processExtraArrayElements(editorPath) {
            for (var z in addArray) {
                if (addArray[z].editorPath != editorPath) {
                    addArrayElement(addArray[z].editorPath,
                        addArray[z].newEditorPath, addArray[z].parentPathInJson);
                }
            }
            addArray = [];
        }

        function processAllRelatedIndexes() {
            //add new value into all related indexes
            obj = document.getElementsByTagName("select");
            for (var z in obj) {
                if (obj[z].attributes && obj[z].attributes["name"]) {
                    console.log("searching for " + obj[z].attributes["name"]["nodeValue"] + " for the end");
                    obj2 = findOutputObject(obj[z].attributes["name"]["nodeValue"], false);
                    console.log(obj2);
                    if (obj2 != null) {
                        for (j = 0; j < obj2.obj.length; j++) {
                            var f = false;
                            for (jj = 0; jj < obj[z].options.length; jj++) {
                                if (obj[z].options[jj].value == j) {
                                    f = true;
                                    break;
                                }
                            }
                            if (!f) {
                                var op = document.createElement('option');
                                op.value = j;
                                op.innerHTML = j;
                                obj[z].add(op);
                            }
                        }
                    }
                }
            }
        }

        function processSelect(pathInInputData, value, parentPath) {
            console.log("processSelect '" + pathInInputData + "' '" + value + "'");
            console.log(selectAddReplace);
            var pathObj = pathInInputData.split(".");
            var elementToProcess = inputData[pathObj[0]][pathObj[1]];
            console.log(elementToProcess);
            for (var j = 3; j < elementToProcess.length; j = j + 2) {
                if (elementToProcess[j] == value) {
                    var retVal = "";
                    var sectionObj = elementToProcess[j + 1].split(".");
                    for (s in sectionObj) {
                        retVal += processEditorPart(sectionObj[s], parentPath,
                            selectAddReplace[parentPath + pathInInputData], parentPath + pathInInputData);
                    }
                    document.getElementById(parentPath + pathInInputData).innerHTML = retVal;
                    processExtraArrayElements("");
                    processAllRelatedIndexes();
                    document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                    console.log("selectAddReplace after select");
                    console.log(selectAddReplace);
                    break;
                }
            }
        }

	//todo delete elements outside (with $.)
        function deleteArrayElement(path, minimum) {
            console.log("Delete array alement " + path);
            var obj = findOutputObject(path, true);
            var info = obj.lastPathElement.split(/[\[,\]]/);
            if (obj.obj[info[0]].length == Number(minimum)) {
                alert('Array ' + path + ' needs at least ' + minimum + ' elements');
            } else {
                var pathObj = path.split(".");
                pathObj[pathObj.length - 1] = info[0];
                console.log(pathObj.join("."));
                for (var jj in selectAddReplace) {
                    obj2 = selectAddReplace[jj];
                    for (jjj in obj2) {
                        console.log("jjj " + jjj);
                        if (jjj.startsWith(pathObj.join(".") + "[]") && obj2[jjj].startsWith(path)) {
                            console.log("deleting " + jjj);
                            console.log(obj2);
                            delete obj2[jjj];
                        }
                    }
                    if (Object.keys(obj2).length == 0) delete selectAddReplace[jj];
                    console.log("len in " + Object.keys(obj2).length + " in index " + jj);
                }
                console.log("selectAddReplace after deleting part 1");
                console.log(selectAddReplace);
                for (var jj in selectAddReplace) {
                    obj2 = selectAddReplace[jj];
                    for (jjj in obj2) {
                        console.log("jjj " + jjj);
                        if (jjj.startsWith(pathObj.join(".") + "[]")) {
                            pathObj2 = obj2[jjj].split(".");
                            var info2 = pathObj2[pathObj2.length - 1].split(/[\[,\]]/);
                            if (Number(info2[1]) > Number(info[1])) {
                                pathObj2[pathObj2.length - 1] = info2[0] + "[" + (Number(info2[1]) - 1) + "]";
                                obj2[jjj] = pathObj2.join(".");
                            }
                        }
                    }
                }
                //remove from json
                obj.obj[info[0]].splice(info[1], 1);
                //remove from editor
                if (document.getElementById(path) != null) {
                    document.getElementById(path).remove();
                }
                //change id for allowing searching all elements
                obj0 = [document.getElementsByTagName("input"),
                    document.getElementsByTagName("select"),
                    document.getElementsByTagName("span"),
                    document.getElementsByTagName("button")
                ];
                for (var jj in obj0) {
                    obj = obj0[jj];
                    for (var j in obj) {
                        //remove value from select with array index
                        if (obj[j].attributes && obj[j].attributes["name"]) {
                            if (obj[j].attributes["name"]["nodeValue"] == pathObj.join(".") + "[]") {
                                console.log(obj[j]);
                                //remove highest value
                                toDelete = -1;
                                toDeleteValue = 0;
                                for (var jjj = 0; jjj < obj[j].length; jjj++) {
                                    if (Number(obj[j][jjj].value) >= toDeleteValue) {
                                        toDelete = jjj;
                                        toDeleteValue = Number(obj[j][jjj].value);
                                    }
                                }
                                obj[j].remove(toDelete);
                                //todo: select new value in select
                                if (obj[j].length == 0) {
                                    editStringBoolNum(obj[j].id, "", false);
                                }
                            }
                        }
                        //update indexes of existing elements in the array
                        if (obj[j].id != null && obj[j].id.startsWith(pathObj.join("."))) {
                            pathObj2 = obj[j].id.split(".");
                            var info2 = pathObj2[pathObj.length - 1].split(/[\[,\]]/);
                            if (Number(info2[1]) > Number(info[1])) {
                                var i = Number(info2[1]);
                                pathObj2[pathObj.length - 1] = info2[0] + "[" + (i - 1) + "]";
                                obj[j].id = pathObj2.join(".");
                                //update json value for array indexes
                                if (obj[j].attributes && obj[j].attributes["name"] &&
                                    obj[j].attributes["name"]["nodeValue"] == "arrayindex") {
                                    var obj2 = findOutputObject(pathObj2.join("."), true);
                                    obj2.obj[obj2.lastPathElement] = Number(i - 1);
                                }
                            }
                        }
                    }
                }
                document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                console.log("selectAddReplace after deleting");
                console.log(selectAddReplace);
            }
        }

        function addArrayElement(editorPath, newEditorPath, parentPathInJson) {
            console.log("addArrayElement " + editorPath + " " + newEditorPath + " " + parentPathInJson);
            var pathObj = editorPath.split(".");
            var elementsToProcess = inputData[pathObj[0]][pathObj[1]];
            var obj = findOutputObject(parentPathInJson, true);
            newButton = document.createElement('button');
            newButton.id = obj.path + ".x";
            newButton.setAttribute("name", elementsToProcess[4]); //minimum number of elements
            newButton.addEventListener('click', function(event) {
                deleteArrayElement(this.id.slice(0, -2), this.attributes["name"]["nodeValue"]);
            });
            newButton.innerText = "Delete";
            newDiv = document.createElement('span');
            newDiv.classList.add("full");
            newDiv.style = "display: grid; grid-template-columns: 1fr 1fr;";
            //todo split for newEditorPath
            newDiv.innerHTML = processEditorPart(newEditorPath, obj.path + ".", {}, "");
            newDiv.id = obj.path;
            newDiv.appendChild(newButton);
            document.getElementById(editorPath).appendChild(newDiv);
            processExtraArrayElements(editorPath);
            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
            //add new value into all related indexes
            var info = obj.lastPathElement.split(/[\[,\]]/);
            obj = document.getElementsByTagName("select");
            for (var j in obj) {
                if (obj[j].attributes && obj[j].attributes["name"] &&
                    obj[j].attributes["name"]["nodeValue"] == elementsToProcess[1]) {
                    var op = document.createElement('option');
                    op.value = info[1];
                    op.innerHTML = info[1];
                    obj[j].add(op);
                    //todo setting correct value
                    if (obj[j].length == 1) {
                        editStringBoolNum(obj[j].id, info[1], false);
                    }
                }
            }
        }
        
         function addArrayElement2(pathInInputData, parentPath) {
            console.log("addArrayElement2 '" + pathInInputData + "'");
            console.log(selectAddReplace);
            var pathObj = pathInInputData.split(".");
            var elementToProcess = inputData[pathObj[0]][pathObj[1]];
            console.log(elementToProcess);
    
                   
//                    document.getElementById(parentPath + pathInInputData).innerHTML = retVal;
                    
                    
                    
                    newButton = document.createElement('button');
            newButton.id = obj.path + ".x";
          //  newButton.setAttribute("name", elementsToProcess[4]); //minimum number of elements
            newButton.addEventListener('click', function(event) {
                deleteArrayElement(this.id.slice(0, -2), this.attributes["name"]["nodeValue"]);
            });
            newButton.innerText = "Delete";
            newDiv = document.createElement('span');
            newDiv.classList.add("full");
            newDiv.style = "display: grid; grid-template-columns: 1fr 1fr;";

             var retVal = "";
                    var sectionObj = elementToProcess[2].split(".");
                    for (s in sectionObj) {
                        retVal += processEditorPart(sectionObj[s], parentPath,
                            selectAddReplace[parentPath + pathInInputData], parentPath + pathInInputData);
                    }
                    
            newDiv.innerHTML = retVal;
         //   newDiv.id = obj.path;
            newDiv.appendChild(newButton);
            document.getElementById(pathInInputData).appendChild(newDiv);
            
                    processExtraArrayElements("");
                    processAllRelatedIndexes();
                    document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                    console.log("selectAddReplace after select");
                    console.log(selectAddReplace);
        }

        function loadBase64File(f, path) {
            const reader = new FileReader();
            reader.onload = function(e2) {
                var obj = findOutputObject(path, true);
                obj.obj[obj.lastPathElement] = (new Uint8Array(e2.target.result)).toBase64();
                document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                document.getElementById(path + "_get").setAttribute('download', document.getElementById(path).files[0].name);
            };
            reader.readAsArrayBuffer(f);
        }

        function getOutputBase64File(path) {
            obj = findOutputObject(path, false);
            if (obj.obj[obj.lastPathElement].length != 0) {
                document.getElementById(path + "_get").setAttribute('href', 'data:;base64,' + obj.obj[obj.lastPathElement]);
            } else {
                alert('Empty file content');
            }
        }

        function loadHexFile(f, path) {
            const reader = new FileReader();
            reader.onload = function(e2) {
                var obj = findOutputObject(path, true);
                obj.obj[obj.lastPathElement] = (new Uint8Array(e2.target.result)).toHex().toUpperCase();
                document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                document.getElementById(path + "_get").setAttribute('download', document.getElementById(path).files[0].name);
            };
            reader.readAsArrayBuffer(f);
        }

        function getOutputHexFile(path) {
            obj = findOutputObject(path, false);
            if (obj.obj[obj.lastPathElement].length != 0) {
                obj2 = new Uint8Array(obj.obj[obj.lastPathElement].length / 2);
                obj2.setFromHex(obj.obj[obj.lastPathElement].toLowerCase());
                document.getElementById(path + "_get").setAttribute('href', 'data:;base64,' + (new Uint8Array(obj2)).toBase64());
            } else {
                alert('Empty file content');
            }
        }

        function getPathValueToCheck(parentPath, path, value, addreplace) {
            var valueToCheck = value;
            var pathList = path.split(",");
            for (var p in pathList) {
                var obj = findOutputObject(getAddReplace(parentPath, pathList[p], addreplace), value != null);
                if (obj.isNewValue) {
                    if (value != null) obj.obj[obj.lastPathElement] = value;
                } else {
                    if (obj.obj != null) valueToCheck = obj.obj[obj.lastPathElement];
                }
                pathList[p] = obj.path;
            }
            var retVal = {};
            retVal.path = pathList.join(",");
            retVal.value = valueToCheck;
            return retVal;
        }

        function getAddReplace(parentPath, path, addReplace) {
            console.log("getAddReplace start " + parentPath + " " + path);
            console.log(addReplace);
            var pathList = path.split(",");
            for (var p in pathList) {
                if (pathList[p].startsWith("$.")) {
                    pathList[p] = pathList[p].substring(2);
                } else {
                    pathList[p] = parentPath + pathList[p];
                }
                for (var a in addReplace) {
                    pathList[p] = pathList[p].replace(a, addReplace[a]);
                }
            }
            console.log("getAddReplace end " + pathList.join(","));
            return pathList.join(",");
        }

        function processEditorPart(sections, parentPath, addreplace, selectname) {
            console.log("processEditorPart start '" + sections + "' '" + parentPath + "'" + " " + selectname);
            console.log(addreplace);
            var editorText = "";
            var sectionList = sections.split(",");
            var addReplace = addreplace == null ? {} : JSON.parse(JSON.stringify(addreplace));
            for (var s in sectionList) {
                var section = sectionList[s];
                var elementsToProcess = inputData[section];
                for (var i in elementsToProcess) {
                    console.log(elementsToProcess[i]);
                    processing = section + "." + i;
                    if (elementsToProcess[i][0] == "select") {
                        //option menu. Can do something extra during changing to concrete value.
                        //0 type, 1 description, 2 default,  (3 name, 4 sections for processing)...
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][1] + "</label>";
                        editorText += "<select onchange=processSelect('" + section + "." + i + "',this.value,'" + parentPath + "');>";
                        for (j = 3; j < elementsToProcess[i].length; j = j + 2) {
                            editorText += "<option value='" + elementsToProcess[i][j] + "'";
                            if (elementsToProcess[i][2] == elementsToProcess[i][j]) editorText += " selected";
                            editorText += ">" + elementsToProcess[i][j] + "</option>";
                        }
                        editorText += "</select>";
                        selectAddReplace[parentPath + section + "." + i] = JSON.parse(JSON.stringify(addReplace));
                        editorText += "<span id='" + parentPath + section + "." + i + "' class=full>";
                        for (j = 3; j < elementsToProcess[i].length; j = j + 2) {
                            if (elementsToProcess[i][2] == elementsToProcess[i][j]) {
                                editorText += processEditorPart(elementsToProcess[i][j + 1], parentPath, addReplace,
                                    parentPath + section + "." + i);
                            }
                        }
                        editorText += "</span>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "array") {
                        //array with adding/removing elements
                        //0 type, 1 path, 2 description, 3 section, 4 minimum elements
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<input type=button value='Add'";
                        editorText += " onclick=addArrayElement('" + section + "." + i + "','" +
                            elementsToProcess[i][3] + "','" +
                            parentPath + elementsToProcess[i][1] + "');>";
                        editorText += "<span id='" + section + "." + i + "' class=full></span>";
                        for (var j = 0; j < Number(elementsToProcess[i][4]); j++) {
                            var ret = {};
                            ret.editorPath = section + "." + i;
                            ret.newEditorPath = elementsToProcess[i][3];
                            ret.parentPathInJson = parentPath + elementsToProcess[i][1];
                            addArray.push(ret);
                        }
                        editorText += "</span>";
                     } else if (elementsToProcess[i][0] == "adddelete") {
                        //array with adding/removing elements
                        //0 type, 1 description, 2 section add, 3 section delete, 4 minimum elements
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<input type=button value='Add'";
                        editorText += " onclick=addArrayElement2('" + section + "." + i + "','" + parentPath + "');>";
                        editorText += "<span id='" + parentPath + section + "." + i + "' class=full></span>";
                       /* for (var j = 0; j < Number(elementsToProcess[i][4]); j++) {
                            var ret = {};
                            ret.editorPath = section + "." + i;
                            ret.newEditorPath = elementsToProcess[i][3];
                            ret.parentPathInJson = parentPath + elementsToProcess[i][1];
                            addArray.push(ret);
                        }*/
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "link") {
                        //link to existing structure
                        //0 type, 1 path, 2 section
                        if (elementsToProcess[i][1] != "") {
                            obj = findOutputObject(getAddReplace(parentPath, elementsToProcess[i][1], addReplace), true);
                            //   elementsToProcess[i][1] = obj.path;
                            editorText += processEditorPart(elementsToProcess[i][2], obj.path + ".", addReplace, selectname);
                            //			editorText += processEditorPart(elementsToProcess[i][2], elementsToProcess[i][1] + ".", addReplace, selectname);
                        } else {
                            editorText += processEditorPart(elementsToProcess[i][2], "", addReplace, selectname);
                        }
                    } else if (elementsToProcess[i][0] == "index") {
                        //field with index of existing array
                        //0 type, 1 path
                        obj2 = parentPath.slice(0, -1).split(".");
                        info = obj2[obj2.length - 1].split(/[\[,\]]/);
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], Number(info[1]), addReplace);
                        editorText += "<span name=arrayindex id='" + pathValue.path + "'></span>";
                    } else if (elementsToProcess[i][0] == "other") {
                        //field with other array index (for selecting)
                        //0 type, 1 path, 2 description, 3 other array path
                        //todo setting values in all situations
                        obj = findOutputObject(parentPath + elementsToProcess[i][1], true);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<select name='" + elementsToProcess[i][3] + "' id='" + elementsToProcess[i][1] + "'";
                        editorText += " oninput=editStringBoolNum(this.id,this.value,false);>";
                        editorText += "</select>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "delete") {
                        //deleting smth from json
                        //0 type, 1 path
                        console.log(addReplace);
                        console.log(selectAddReplace);
                        pathList = elementsToProcess[i][1].split(",");
                        for (p in pathList) {
                            obj = findOutputObject(getAddReplace(parentPath, pathList[p], selectAddReplace[selectname]), false);
                            if (obj.obj != null && obj.lastPathElement != null) {
                                if (obj.lastPathElement.includes("[")) {
                                    deleteArrayElement(obj.path, 0);
                                } else {
                                    console.log("deleting " + obj.lastPathElement);
                                    delete obj.obj[obj.lastPathElement];
                                    console.log(obj.obj);
                                }
                            }
                        }
                    } else if (elementsToProcess[i][0] == "const") {
                        //0 type, 1 path, 2 value
                        pathList = elementsToProcess[i][1].split(",");
                        for (p in pathList) {
                            obj = findOutputObject(getAddReplace(parentPath, pathList[p], addReplace), true);
                            if (obj.isNewValue) {
                                obj.obj[obj.lastPathElement] = elementsToProcess[i][2];
                            }
                        }
                    } else if (elementsToProcess[i][0] == "random") {
                        //put into json random value. When you put this is before string,
                        //it can replace default value from string (only when it didn't exist in json)
                        //0 type, 1 path, 2 allowed chars, 3 length, 4 string before, 5 string after
                        var s = "";
                        for (var j = 0; j < Number(elementsToProcess[i][3]); j++) {
                            s += elementsToProcess[i][2].charAt(Math.random() * elementsToProcess[i][2].length);
                        }
                        getPathValueToCheck(parentPath, elementsToProcess[i][1],
                            elementsToProcess[i][4] + s + elementsToProcess[i][5], addReplace);
                    } else if (elementsToProcess[i][0] == "separator") {
                        //0 type, 1 text
                        editorText += "<span class=full><br>&nbsp;<br>";
                        editorText += "<label><b>" + elementsToProcess[i][1] + "</b></label>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "addreplace") {
                        pathList = elementsToProcess[i][1].split(",");
                        for (p in pathList) {
                            obj = findOutputObject(getAddReplace(parentPath, pathList[p], addReplace), true);
                            addReplace[getAddReplace(parentPath, pathList[p], addReplace)] = obj.path;
                        }
                        console.log("addReplace");
                        console.log(addReplace);
                        if (selectname != "") {
                            selectAddReplace[selectname] = JSON.parse(JSON.stringify(addReplace));
                        }
                    } else if (elementsToProcess[i][0] == "button") {
                        //array with adding/removing elements
                        //0 type, 1 description, 2 path
                        /*                        editorText += "<span class=full>";
                                                editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                                                editorText += "<input type=button value='Add'";
                                                editorText += " onclick=addArrayElement('" + section + "." + i + "','" + elementsToProcess[i][3] + "','" + parentPath + elementsToProcess[i][1] + "');>";
                                                editorText += "<span id='" + section + "." + i + "' class=full></span>";
                                                editorText += "</span>";*/
                    } else if (elementsToProcess[i][0] == "string") {
                        //0 type, 1 path, 2 description, 3 default, 4 minimum len, 5 maximum len, 6 parsing regexp
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<input";
                        if (pathValue.value != null) editorText += " value='" + pathValue.value + "'";
                        editorText += " id='" + pathValue.path + "'";
                        if (elementsToProcess[i][4] != elementsToProcess[i][5]) {
                            editorText += " minlength=" + elementsToProcess[i][4];
                            editorText += " maxlength=" + elementsToProcess[i][5];
                        }
                        editorText += " oninput=editStringBoolNum(this.id,this.value,false);setEditErrors(this.id,this.value,'" +
                            section + "','" + i + "');><br>";
                        editorText += "<span id='" + pathValue.path + "_error'>";
                        editorText += parseEditErrors(section, i, pathValue.value);
                        editorText += "</span>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "number") {
                        //0 type, 1 path, 2 description, 3 default, 4 minimum, 5 maximum, 6 step
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<input";
                        if (pathValue.value != null) editorText += " value=" + pathValue.value;
                        editorText += " step=" + elementsToProcess[i][6] + " type=number id='" + pathValue.path + "'";
                        if (elementsToProcess[i][4] != elementsToProcess[i][5]) {
                            editorText += " min=" + elementsToProcess[i][4];
                            editorText += " max=" + elementsToProcess[i][5];
                        }
                        editorText += " oninput=editStringBoolNum(this.id,this.value,true);setEditErrors(this.id,this.value,'" +
                            section + "','" + i + "');><br>";
                        editorText += "<span id='" + pathValue.path + "_error'>";
                        editorText += parseEditErrors(section, i, pathValue.value);
                        editorText += "</span>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "date") {
                        //0 type, 1 path, 2 description, 3 default, 4 minimum, 5 maximum
                        const date = new Date();
                        const dateVal = date.getFullYear() + "-" +
                            (date.getMonth() + 1 < 10 ? "0" : "") + (date.getMonth() + 1) + "-" +
                            (date.getDate() < 10 ? "0" : "") + date.getDate();
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1],
                            elementsToProcess[i][3] == "" ? dateVal : elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<input value='" + pathValue.value + "' ";
                        if (elementsToProcess[i][4] != elementsToProcess[i][5]) {
                            editorText += " min=" + elementsToProcess[i][4];
                            editorText += " max=" + elementsToProcess[i][5];
                        }
                        editorText += " id='" + pathValue.path + "' type=date oninput=editStringBoolNum(this.id,this.value,false);><br>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "checkbox") {
                        //real true & false in json. For string use option
                        //0 type, 1 path, 2 description, 3 default
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<input type=checkbox";
                        if (elementsToProcess[i][3]) editorText += " checked";
                        editorText += " id='" + pathValue.path + "' oninput=editStringBoolNum(this.id,this.checked,false);><br>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "option") {
                        //select one of predefined options
                        //0 type, 1 path, 2 description, 3 default, 4,5... values
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<select id='" + pathValue.path + "' onchange=editStringBoolNum(this.id,this.value,false);>";
                        for (j = 4; j < elementsToProcess[i].length; j++) {
                            editorText += "<option value='" + elementsToProcess[i][j] + "'";
                            if (elementsToProcess[i][3] == elementsToProcess[i][j]) editorText += " selected";
                            editorText += ">" + elementsToProcess[i][j] + "</option>";
                        }
                        editorText += "</select>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "file64") {
                        //Base64 encoded file
                        //0 type, 1 path, 2 description, 3 default
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<a id='" + pathValue.path + "_get' href='' download='" + elementsToProcess[i][1];
                        editorText += "' onclick=getOutputBase64File('" + pathValue.path + "');>Get File</a>";
                        editorText += "<input type=file id='" + pathValue.path + "' onchange=loadBase64File(this.files[0],this.id);><br>";
                        editorText += "</span>";
                    } else if (elementsToProcess[i][0] == "fileHex") {
                        //HexDec encoded file
                        //0 type, 1 path, 2 description, 3 default
                        pathValue = getPathValueToCheck(parentPath, elementsToProcess[i][1], elementsToProcess[i][3], addReplace);
                        editorText += "<span class=full>";
                        editorText += "<label>" + elementsToProcess[i][2] + "</label>";
                        editorText += "<a id='" + pathValue.path + "_get' href='' download='" + elementsToProcess[i][1];
                        editorText += "' onclick=getOutputHexFile('" + pathValue.path + "');>Get File</a>";
                        editorText += "<input type=file id='" + pathValue.path + "' onchange=loadHexFile(this.files[0],this.id);><br>";
                        editorText += "</span>";
                    }
                }
            }
            console.log("processEditorPart end '" + section + "' '" + parentPath + "'");
            return editorText;
        }

        document.getElementById("file").addEventListener("change",
            function(e) {
                const fReader = new FileReader();
                fReader.onload = function(e2) {
                    jsonTxt = e2.target.result;
                    try {
                        inputData = JSON.parse(jsonTxt);
                        if (inputData.start == null) {
                            alert("No start section in file '" + document.getElementById('file').files[0].name +
                                "'. Processing element '" + processing + "'. " +
                                "Is this really json file with json description?");
                        } else {
                            outputData = {};
                            addArray = [];
                            selectAddReplace = {};
                            document.getElementById("editor").innerHTML = processEditorPart("start", "", {}, "");
                            processExtraArrayElements('');
                            processAllRelatedIndexes();
                            document.getElementById("json").innerHTML = JSON.stringify(outputData, null, 2);
                            console.log(selectAddReplace);
                        }
                    } catch (ee) {
                        alert("Error opening file '" + document.getElementById('file').files[0].name +
                            "'. Processing element '" + processing + "'. " +
                            "Is this really json file with json description?\n\n" + ee.name + "\n\n" + ee.message);
                    }
                };
                fReader.readAsText(e.target.files[0]);
            });
    </script>
</body>

</html>
